<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Horarios (Tiempo Real)</title>
    <!-- Enlace al Manifest para la PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <style>
        :root{--bg-color:#f4f7f9;--surface-color:#fff;--text-color:#34495e;--text-secondary-color:#7f8c8d;--border-color:#ecf0f1;--shadow-color:rgba(0,0,0,.1);--primary-color:#3498db;--primary-hover-color:#2980b9;--disabled-color:#bdc3c7;--timer-color:#2c3e50;--success-color:#2ecc71;--danger-color:#e74c3c;--danger-hover-color:#c0392b;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--bg-color);margin:0;padding:20px;color:var(--text-color);font-size:16px}
        .container{max-width:1200px;margin:0 auto;background-color:var(--surface-color);padding:20px;border-radius:8px;box-shadow:0 4px 6px var(--shadow-color)}
        .header{text-align:center;margin-bottom:25px;border-bottom:1px solid var(--border-color);padding-bottom:20px}
        h1{color:var(--primary-color);margin:0}
        .controls{display:flex;justify-content:center;align-items:center;gap:15px;margin-top:15px;flex-wrap:wrap}
        #current-time{font-size:1.5em;font-weight:700;color:var(--timer-color);margin-top:10px}
        .controls label{font-weight:700}
        .controls input[type=date]{padding:8px;border:1px solid var(--border-color);border-radius:5px;font-size:1em}
        #status-message{text-align:center;font-size:1.2em;color:var(--text-secondary-color);padding:40px 0}
        .horario-tabla-container{overflow-x:auto}
        .tabla{width:100%;border-collapse:collapse;margin-top:20px}
        .tabla td,.tabla th{border:1px solid var(--border-color);padding:8px;text-align:center;font-size:.9em;white-space:nowrap}
        .tabla thead th{background-color:#e9ecef;font-weight:700;position:sticky;top:0;z-index:2}
        .tabla tbody th{text-align:left;font-weight:700;background-color:#f8f9fa;position:sticky;left:0;z-index:1;transition:background-color .3s ease,color .3s ease}
        .croupier-timer{font-size:.9em;font-weight:400;color:var(--timer-color);display:block;margin-top:4px;transition:color .3s ease}
        .relevo-cell-view{padding:4px;border-radius:4px;font-size:.85em;font-weight:700;color:#fff;line-height:1.3;display:block;min-height:20px}
        .relevo-cell-view.ayudante-pagador{background-color:#8e44ad}
        .relevo-cell-view.descanso{background-color:#f39c12}
        .horario-nav{display:flex;justify-content:space-between;align-items:center;margin-top:15px}
        .nav-button{background-color:var(--primary-color);color:#fff;border:none;padding:10px 20px;border-radius:5px;font-weight:700;cursor:pointer;transition:background-color .3s ease}
        .nav-button:hover{background-color:var(--primary-hover-color)}
        .nav-button:disabled{background-color:var(--disabled-color);cursor:not-allowed}
        #info-horarios{font-weight:700;color:var(--text-secondary-color)}
        .tabla tbody th.timer-active{background-color:var(--success-color) !important;color:#fff}
        .tabla tbody th.timer-active .croupier-timer{color:#fff;font-weight:700}
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 10px 20px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        .tabla tr.salida-warning {
            background-color: var(--danger-color) !important;
            animation: pulse 1.5s infinite;
            color: white;
        }
        .tabla tr.salida-warning th, .tabla tr.salida-warning td {
            background-color: transparent !important;
            color: white !important;
        }
        .tabla tr.salida-warning .croupier-timer {
            color: white !important;
        }

        footer {
            margin-top: 25px;
            padding-top: 15px;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary-color);
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Visualizador de Horarios (Tiempo Real)</h1>
            <div id="current-time">00:00:00</div>
            <div class="controls">
                <label for="fecha-selector">Seleccionar Fecha:</label>
                <input type="date" id="fecha-selector">
            </div>
        </div>
        <div id="status-message">Cargando...</div>
        <div id="horario-wrapper" style="display: none;">
            <div class="horario-nav">
                <button id="btn-prev" class="nav-button">&lt; Anterior</button>
                <span id="info-horarios"></span>
                <button id="btn-next" class="nav-button">Siguiente &gt;</button>
            </div>
            <div id="horario-container" class="horario-tabla-container"></div>
        </div>
        
        <footer>
             <p style="margin-top: 15px;">CarlosPN Interactive®</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const URL_DEL_SCRIPT_DE_HORARIOS = 'https://script.google.com/macros/s/AKfycbw1kBHYt37_X5K7UdBZlJNTgNT2B2P0t4F6uVrCKK_hDgZ7j09cwSzNx5l9CvHwFCTDQg/exec';
            
            // LÓGICA DE HORARIOS
            let datosCompletosDelHorario = null;
            let indiceActual = 0;
            const COLUMNAS_VISIBLES = 3;
            let timerInterval = null;
            let refreshInterval = null;
            let cronometroIntervals = {};
            let isAutoScrolling = true;
            const fechaSelector = document.getElementById('fecha-selector');
            const updateClock = () => { document.getElementById('current-time').textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); };
            setInterval(updateClock, 1000);
            updateClock();
            const getLocalDateString = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };
            const loadSchedule = async (fecha, isInitialLoad = true) => {
                if (isInitialLoad) {
                    document.getElementById('status-message').textContent = 'Cargando horario...';
                    document.getElementById('status-message').style.display = 'block';
                    document.getElementById('horario-wrapper').style.display = 'none';
                    if (timerInterval) clearInterval(timerInterval);
                    if (refreshInterval) clearInterval(refreshInterval);
                    Object.values(cronometroIntervals).forEach(clearInterval);
                    cronometroIntervals = {};
                    isAutoScrolling = true;
                }
                try {
                    const response = await fetch(`${URL_DEL_SCRIPT_DE_HORARIOS}?action=load&fecha=${fecha}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                    const newData = await response.json();
                    if (isInitialLoad) {
                        datosCompletosDelHorario = newData;
                        if (newData && newData.found) {
                            document.getElementById('status-message').style.display = 'none';
                            document.getElementById('horario-wrapper').style.display = 'block';
                            newData.horarios.sort(sortHorarios);
                            renderCurrentView(); 
                            actualizarSistema(); 
                            timerInterval = setInterval(actualizarSistema, 1000);
                            refreshInterval = setInterval(() => loadSchedule(fechaSelector.value, false), 15000);
                        } else {
                            handleNoSchedule(fecha);
                        }
                    } else if (newData && newData.found) {
                        updateScheduleSilently(newData);
                    }
                } catch (error) {
                    console.error('Error al cargar el horario:', error);
                    document.getElementById('status-message').textContent = 'Error al conectar con la base de datos.';
                }
            };
            const handleNoSchedule = (fecha) => {
                 document.getElementById('status-message').textContent = `No se encontró un horario para el ${new Date(fecha + 'T00:00:00').toLocaleTimeString('es-ES', {day: '2-digit', month:'long', year:'numeric'})}.`;
                 document.getElementById('status-message').style.display = 'block';
                 document.getElementById('horario-wrapper').style.display = 'none';
            }
            const updateScheduleSilently = (newData) => {
                const structureChanged = 
                    JSON.stringify(datosCompletosDelHorario.croupiersEnTabla) !== JSON.stringify(newData.croupiersEnTabla) ||
                    JSON.stringify(datosCompletosDelHorario.horarios) !== JSON.stringify(newData.horarios);
                datosCompletosDelHorario = newData;
                datosCompletosDelHorario.horarios.sort(sortHorarios);
                if (structureChanged) {
                    renderCurrentView();
                } else {
                    const { croupiersEnTabla, horarios, datosRelevos, croupierColors } = datosCompletosDelHorario;
                    const horariosVisibles = horarios.slice(indiceActual, indiceActual + COLUMNAS_VISIBLES);
                    croupiersEnTabla.forEach((croupier, rowIndex) => {
                        const croupierId = croupier.replace(/\s+/g, '-');
                        const row = document.getElementById(`row-${croupierId}`);
                        if (!row) return;
                        horariosVisibles.forEach((hora, colIndex) => {
                            const td = row.cells[colIndex + 1];
                            if (!td) return;
                            const data = datosRelevos[croupier]?.[hora];
                            const currentContent = td.innerHTML;
                            let newContent = '';
                            if (data) {
                                const div = crearTarjetaRelevo(data);
                                newContent = div.outerHTML;
                            }
                            if (currentContent !== newContent) {
                                td.innerHTML = newContent;
                            }
                        });
                    });
                }
            };
            const crearTarjetaRelevo = (data) => {
                const div = document.createElement('div');
                div.className = 'relevo-cell-view';
                switch (data.actividad) {
                    case 'releva': div.style.backgroundColor = data.color; div.textContent = data.mesas.join(' - '); break;
                    case 'ayudante-pagador': div.classList.add('ayudante-pagador'); div.textContent = 'A. PAGADOR'; break;
                    case 'descanso': div.classList.add('descanso'); div.textContent = 'DESCANSO'; break;
                    default: div.style.backgroundColor = '#95a5a6'; div.textContent = 'S/A';
                }
                return div;
            };
            const sortHorarios = (a, b) => { let aH = parseInt(a.split(':')[0],10),bH=parseInt(b.split(':')[0],10); if(aH<6)aH+=24;if(bH<6)bH+=24;if(aH<bH)return-1;if(aH>bH)return 1;return parseInt(a.split(':')[1],10)-parseInt(b.split(':')[1],10);};
            const renderCurrentView = () => {
                if (!datosCompletosDelHorario || !datosCompletosDelHorario.found || datosCompletosDelHorario.croupiersEnTabla.length === 0) {
                    handleNoSchedule(fechaSelector.value);
                    return;
                }
                const { croupiersEnTabla, horarios, datosRelevos, croupierColors } = datosCompletosDelHorario;
                const container = document.getElementById('horario-container');
                container.innerHTML = '';
                const horariosVisibles = horarios.slice(indiceActual, indiceActual + COLUMNAS_VISIBLES);
                const table = document.createElement('table'); table.className = 'tabla';
                const thead = document.createElement('thead');
                let headerRow = '<tr><th>Croupier</th>';
                horariosVisibles.forEach(hora => headerRow += `<th>${hora}</th>`);
                thead.innerHTML = headerRow + '</tr>';
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                croupiersEnTabla.forEach(croupier => {
                    const tr = document.createElement('tr');
                    const croupierId = croupier.replace(/\s+/g, '-');
                    tr.id = `row-${croupierId}`;
                    const th = document.createElement('th');
                    th.innerHTML = `${croupier}<span class="croupier-timer" id="timer-${croupierId}">00:00:00</span>`;
                    if (croupierColors && croupierColors[croupier]) {
                        th.style.backgroundColor = croupierColors[croupier];
                        const c = croupierColors[croupier].replace('#','');
                        const lum=(0.299*parseInt(c.substring(0,2),16)+0.587*parseInt(c.substring(2,4),16)+0.114*parseInt(c.substring(4,6),16))/255;
                        th.style.color = lum < 0.5 ? 'white' : 'black';
                        th.querySelector('.croupier-timer').style.color = lum < 0.5 ? 'white' : 'var(--timer-color)';
                    }
                    tr.appendChild(th);
                    horariosVisibles.forEach(hora => {
                        const td = document.createElement('td');
                        const data = datosRelevos[croupier]?.[hora];
                        if (data) {
                           td.appendChild(crearTarjetaRelevo(data));
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                container.appendChild(table);
                actualizarNavegacion();
                actualizarSistema();
            };
            const actualizarNavegacion = () => {
                if (!datosCompletosDelHorario || !datosCompletosDelHorario.found) return;
                const total = datosCompletosDelHorario.horarios.length;
                const fin = Math.min(indiceActual + COLUMNAS_VISIBLES, total);
                document.getElementById('btn-prev').disabled = indiceActual === 0;
                document.getElementById('btn-next').disabled = fin >= total;
                document.getElementById('info-horarios').textContent = `Mostrando ${indiceActual + 1} - ${fin} de ${total}`;
            };
            function actualizarSistema() {
                if (!datosCompletosDelHorario || !datosCompletosDelHorario.found) return;
                const now = new Date();
                const { croupiersEnTabla, horarios, datosRelevos, cronometroStartTime, horasSalida } = datosCompletosDelHorario;
                const fechaVisible = new Date(fechaSelector.value + 'T00:00:00');
                const sortedHorarios = [...horarios].sort(sortHorarios);
                const horariosDate = sortedHorarios.map(h => {
                    const [hour, minute] = h.split(':');
                    const date = new Date(fechaVisible);
                    date.setHours(hour, minute, 0, 0);
                    if (parseInt(hour, 10) < 6) { date.setDate(date.getDate() + 1); }
                    return date;
                });
                let currentScheduleIndex = -1;
                for (let i = horariosDate.length - 1; i >= 0; i--) {
                    if (now >= horariosDate[i]) {
                        currentScheduleIndex = i;
                        break;
                    }
                }
                if (isAutoScrolling) {
                    let newIndice = 0;
                    if (currentScheduleIndex > 0) { newIndice = Math.max(0, currentScheduleIndex -1); }
                    if (newIndice !== indiceActual) { indiceActual = newIndice; renderCurrentView(); }
                }
                croupiersEnTabla.forEach(croupier => {
                    const croupierId = croupier.replace(/\s+/g, '-');
                    const thElement = document.querySelector(`#timer-${croupierId}`)?.closest('th');
                    const rowElement = document.getElementById(`row-${croupierId}`);
                    const isManual = cronometroStartTime && cronometroStartTime.hasOwnProperty(croupier);
                    const isRunning = cronometroIntervals.hasOwnProperty(croupier);
                    if (isManual) {
                        if (!isRunning) iniciarCronometro(croupier, cronometroStartTime[croupier]);
                        if (thElement) thElement.classList.add('timer-active');
                    } else {
                        let lastActivity = null, lastActivityTime = null;
                        for (let i = currentScheduleIndex; i >= 0; i--) {
                            const activity = datosRelevos[croupier]?.[sortedHorarios[i]];
                            if (activity) { lastActivity = activity; lastActivityTime = horariosDate[i].getTime(); break; }
                        }
                        const isWork = lastActivity && (lastActivity.actividad === 'releva' || lastActivity.actividad === 'ayudante-pagador');
                        if (isWork) {
                            if (!isRunning) iniciarCronometro(croupier, lastActivityTime);
                            if (thElement) thElement.classList.add('timer-active');
                        } else {
                            if (isRunning) detenerCronometro(croupier, true);
                            if (thElement) thElement.classList.remove('timer-active');
                        }
                    }
                    const salidaTime = horasSalida ? horasSalida[croupier] : null;
                    let shouldWarn = false;
                    if (salidaTime) {
                        const [h, m] = salidaTime.split(':').map(Number);
                        const salidaDate = new Date(fechaVisible);
                        salidaDate.setHours(h, m, 0, 0);
                        if (h < 6) salidaDate.setDate(salidaDate.getDate() + 1);
                        const diffMinutes = (salidaDate.getTime() - now.getTime()) / 60000;
                        shouldWarn = diffMinutes > 0 && diffMinutes <= 20;
                    }
                    if(rowElement) rowElement.classList.toggle('salida-warning', shouldWarn);
                });
            }
            function iniciarCronometro(croupier, startTime) {
                if (!startTime || cronometroIntervals[croupier]) return;
                const update = () => {
                    const elapsed = new Date().getTime() - startTime;
                    if (elapsed >= 0) {
                       actualizarDisplayCrono(croupier, new Date(elapsed).toISOString().slice(11, 19));
                    }
                };
                cronometroIntervals[croupier] = setInterval(update, 1000);
                update();
            }
            function detenerCronometro(croupier, reset = false) {
                if (cronometroIntervals[croupier]) {
                    clearInterval(cronometroIntervals[croupier]);
                    delete cronometroIntervals[croupier];
                }
                if (reset) actualizarDisplayCrono(croupier, '00:00:00');
            }
            function actualizarDisplayCrono(croupier, tiempo) {
                const croupierId = croupier.replace(/\s+/g, '-');
                const timerEl = document.getElementById(`timer-${croupierId}`);
                if (timerEl) timerEl.textContent = tiempo;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const fechaFromUrl = urlParams.get('fecha');
            const today = new Date();
            const defaultDate = fechaFromUrl || getLocalDateString(today);
            fechaSelector.value = defaultDate;
            loadSchedule(defaultDate, true);
            fechaSelector.addEventListener('change', () => { if (fechaSelector.value) loadSchedule(fechaSelector.value, true); });
            document.getElementById('btn-next').addEventListener('click', () => {
                isAutoScrolling = false;
                if (datosCompletosDelHorario && (indiceActual + COLUMNAS_VISIBLES < datosCompletosDelHorario.horarios.length)) {
                    indiceActual += COLUMNAS_VISIBLES; renderCurrentView();
                }
            });
            document.getElementById('btn-prev').addEventListener('click', () => {
                isAutoScrolling = false;
                if (indiceActual > 0) { indiceActual = Math.max(0, indiceActual - COLUMNAS_VISIBLES); renderCurrentView(); }
            });

            // --- Registro del Service Worker para PWA ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker registrado con éxito:', registration);
                        })
                        .catch(error => {
                            console.error('Fallo al registrar el Service Worker:', error);
                        });
                });
            }
        });
    </script>
</body>
</html>